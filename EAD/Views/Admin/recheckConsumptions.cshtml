@model List<EAD.Models.recheckDailyConsumptionAdminViewModel> 
@{
    ViewData["Title"] = "Manage Recheck Requests";
}

<!-- External Styles for SweetAlert and Icons (Ensure these are in your Layout or here) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

<style>
    /* Theme Consistency Based on Screenshots */
    :root {
        --bg-dark: #151521;
        --card-dark: #2b2b40;
        --text-light: #ffffff;
        --text-muted: #a0a0b0;
        --theme-orange: #d35400; /* Burnt Orange from your Login/Dashboard */
        --theme-green: #27ae60;
        --theme-red: #c0392b;
    }

    body {
        background-color: var(--bg-dark);
        color: var(--text-light);
        font-family: 'Poppins', sans-serif;
    }

    .page-header {
        margin-bottom: 30px;
    }

    .page-title {
        font-size: 24px;
        font-weight: 600;
        color: var(--text-light);
    }

    /* Card Styling */
    .mess-card {
        background-color: var(--card-dark);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    /* Table Styling */
    .table-custom {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 10px; /* Space between rows */
        color: var(--text-light);
    }

    .table-custom thead th {
        color: var(--text-muted);
        font-weight: 500;
        font-size: 0.9rem;
        text-transform: uppercase;
        padding: 15px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .table-custom tbody tr {
        background-color: rgba(255, 255, 255, 0.03); /* Slightly lighter than card */
        transition: transform 0.2s ease;
    }

    .table-custom tbody tr:hover {
        transform: scale(1.01);
        background-color: rgba(255, 255, 255, 0.05);
    }

    .table-custom td {
        padding: 20px 15px;
        vertical-align: middle;
        border-top: none;
        border-bottom: none;
    }

    .table-custom td:first-child { border-radius: 10px 0 0 10px; }
    .table-custom td:last-child { border-radius: 0 10px 10px 0; }

    /* Buttons */
    .btn-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 0 5px;
        color: white;
    }

    .btn-approve {
        background-color: rgba(39, 174, 96, 0.15);
        color: var(--theme-green);
        border: 1px solid rgba(39, 174, 96, 0.3);
    }

    .btn-approve:hover {
        background-color: var(--theme-green);
        color: white;
        box-shadow: 0 0 15px rgba(39, 174, 96, 0.4);
    }

    .btn-reject {
        background-color: rgba(192, 57, 43, 0.15);
        color: var(--theme-red);
        border: 1px solid rgba(192, 57, 43, 0.3);
    }

    .btn-reject:hover {
        background-color: var(--theme-red);
        color: white;
        box-shadow: 0 0 15px rgba(192, 57, 43, 0.4);
    }

    /* Badge for Status */
    .badge-status {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        background-color: rgba(211, 84, 0, 0.15);
        color: var(--theme-orange);
    }

</style>

<div class="container mt-4">
    <div class="page-header d-flex justify-content-between align-items-center">
        <h2 class="page-title">Manage Recheck Requests</h2>
        <!-- Optional: A back button or summary stats could go here -->
    </div>

    <div class="mess-card">
        @if (!Model.Any())
        {
            <div class="text-center py-5">
                <i class="fas fa-check-circle fa-3x mb-3" style="color: var(--theme-orange)"></i>
                <h4 class="text-muted">No pending requests</h4>
                <p class="text-muted">All recheck requests have been processed.</p>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table-custom">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Meal Item</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <!-- Add ID to row for removal logic -->
                            <tr id="row-@item.Id">
                                <td>
                                    <!-- Assuming item has User navigation property -->
                                    <div class="d-flex align-items-center">
                                        <div class="ms-2">
                                            <h6 class="mb-0 text-white">@item.User?.Name</h6>
                                            <small class="text-muted">@item.User?.Email</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    @if(item.MealItem != null)
                                    {
                                        <span class="text-white">@item.MealItem.Name</span> <br/>
                                        <small class="text-muted">PKR @item.MealItem.Price</small>
                                    }
                                </td>
                                <td>@item.ConsumptionDate.ToShortDateString()</td>
                                <td><span class="badge-status">Pending Recheck</span></td>
                                <td class="text-end">
                                    <!-- Approve Button (Accepts claim -> Deletes consumption) -->
                                    <button onclick="confirmAction(@item.Id, 'approve')" class="btn-icon btn-approve" title="Approve (Remove Charge)">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <!-- Reject Button (Denies claim -> Keeps consumption) -->
                                    <button onclick="confirmAction(@item.Id, 'reject')" class="btn-icon btn-reject" title="Reject (Keep Charge)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Get AntiForgery Token
    function getToken() {
        return $('input[name="__RequestVerificationToken"]').val();
    }

    // Consolidated Confirmation Popup
    function confirmAction(id, actionType) {
        let titleText = actionType === 'approve' ? "Approve Recheck?" : "Reject Recheck?";
        let subText = actionType === 'approve' 
            ? "This will remove the charge from the student's bill." 
            : "This will mark the student as Present and keep the charge.";
        let confirmBtnColor = actionType === 'approve' ? '#27ae60' : '#c0392b';
        let btnText = actionType === 'approve' ? 'Yes, Approve it!' : 'Yes, Reject it!';

        // SweetAlert2 Configuration
        Swal.fire({
            title: titleText,
            text: subText,
            icon: 'warning',
            background: '#2b2b40', // Theme Dark Card
            color: '#fff',         // Theme Text
            showCancelButton: true,
            confirmButtonColor: confirmBtnColor,
            cancelButtonColor: '#6c757d',
            confirmButtonText: btnText,
            customClass: {
                popup: 'swal-theme-dark' // Custom class if needed
            }
        }).then((result) => {
            if (result.isConfirmed) {
                processRequest(id, actionType);
            }
        });
    }

    // AJAX Processor
    function processRequest(id, actionType) {
        let url = actionType === 'approve' ? '/Admin/ApproveRecheck' : '/Admin/RejectRecheck'; // Adjust Controller Name

        $.ajax({
            type: "POST",
            url: url,
            data: { id: id, __RequestVerificationToken: getToken() }, // Sending Token
            success: function (response) {
                if (response.success) {
                    // Success Popup
                    Swal.fire({
                        title: 'Success!',
                        text: 'The request has been processed.',
                        icon: 'success',
                        background: '#2b2b40',
                        color: '#fff',
                        confirmButtonColor: '#d35400',
                        timer: 1500,
                        showConfirmButton: false
                    });

                    // Remove row from HTML without reload
                    $("#row-" + id).fadeOut(500, function() { 
                        $(this).remove(); 
                        
                        // Check if table is empty after removal
                        if($("tbody tr").length === 0) {
                            location.reload(); // Reload to show "No Requests" state
                        }
                    });
                } else {
                    // Backend returned false
                    showError("Something went wrong on the server.");
                }
            },
            error: function () {
                showError("Failed to communicate with the server.");
            }
        });
    }

    function showError(msg) {
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: msg,
            background: '#2b2b40',
            color: '#fff',
            confirmButtonColor: '#d35400'
        });
    }
</script>