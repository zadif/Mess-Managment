<h2>Generate Today's Consumption - @ViewBag.Today</h2>

@if (ViewBag.Error != null)
{
    <div class="alert alert-danger">@ViewBag.Error</div>
}
else if (ViewBag.Menus == null || !(ViewBag.Menus as IEnumerable<DailyMenu>)?.Any() == true)
{
    <div class="alert alert-warning">No menu items found for today.</div>
}
else if (ViewBag.Users == null || !(ViewBag.Users as IEnumerable<User>)?.Any() == true)
{
    <div class="alert alert-warning">No active users found.</div>
}
else
{
    <!-- Buttons -->
    <div class="mb-4 text-center">
        <button type="button" id="toggleBtn" class="btn btn-outline-secondary me-3" onclick="toggleCheckboxes()">
            Mark All / Unmark All
        </button>
        <button type="submit" form="saveForm" class="btn btn-success btn-lg px-5">
            Save Today's Consumption
        </button>
        <button type="button" class="btn btn-sm btn-danger" onclick="deleteTodayConsumption()">
            Delete Consumption
        </button>
    </div>

    <!-- Main Table -->
    <form id="saveForm" asp-action="generateDailyConsumptions" method="post">
        @Html.AntiForgeryToken()
        <table class="table table-bordered table-hover">
            <thead class="table-primary">
                <tr>
                    <th>User</th>
                    <th>Type</th>
                    @foreach (var menu in ViewBag.Menus)
                    {
                        <th class="text-center">
                            @menu.MealType<br>
                            <small>@menu.MealItem.Name (₹@menu.MealItem.Price)</small>
                        </th>
                    }
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in ViewBag.Users)
                {
                    var alreadyGenerated = ViewBag.AlreadyGeneratedUserIds?.Contains(user.Id) == true;

                    <tr class="@(alreadyGenerated ? "table-warning" : "")">
                        <td><strong>@user.Name</strong></td>
                        <td>
                            <span class="badge @(user.UserType == 2 ? "bg-success" : "bg-info")">
                                @(user.UserType == 2 ? "Food + Drinks" : "Drinks Only")
                            </span>
                        </td>

                        @if (ViewBag.AlreadyGenerated.Contains(user.Id))
                        {
                            <td colspan="@ViewBag.Menus.Count" class="text-center">
                                <strong>Already Generated</strong>
                            </td>
                        }
                        else
                        {
                            @foreach (var menu in ViewBag.Menus)
                            {
                                var canConsume = user.UserType == 2 || !menu.MealItem.Category.Equals("Food", StringComparison.OrdinalIgnoreCase);
                                <td class="text-center align-middle">
                                    @if (canConsume)
                                    {
                                        <input type="checkbox" name="consumptions" value="@user.Id-@menu.MealItemId"
                                               checked class="item form-check-input" style="transform:scale(1.6)" />
                                    }
                                    else
                                    {
                                        <span class="text-muted">—</span>
                                    }
                                </td>
                            }
                        }

                        <td class="text-center">
                            @if (ViewBag.AlreadyGenerated.Contains(user.Id))
                            {
                                <button type="button" class="btn btn-sm btn-warning" onclick="openEditModal(@user.Id)">
                                    Edit
                                </button>
                                <form asp-action="DeleteUserConsumption" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="userId" value="@user.Id" />
                                    <button type="submit" class="btn btn-sm btn-danger"
                                            onclick="return confirm('Delete consumption for @user.Name today?')">
                                        Delete This User
                                    </button>
                                </form>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </form>
}

<!-- Edit Modal -->
<div id="editModal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h5>Edit Consumption for <span id="modalUserName"></span></h5>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Filled by JS -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-success" onclick="saveEdit()">Save Changes</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
    </div>
</div>



<script src="~/js/generateDailyConsumptions.js"></script>
